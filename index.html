<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ocean Drifter Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path fill='%230056b3' d='M50 60C30 60 10 70 10 80s20 20 40 20 40-10 40-20-20-20-40-20z' /><rect fill='%23333' x='45' y='15' width='10' height='40'/><circle fill='%23d9534f' cx='50' cy='10' r='10'/></svg>">
    
    <!-- Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet.js CSS & JS --><link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Supabase-js Client --><script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Chart.js --><script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- Professional UI --- */
        *, *::before, *::after { border-radius: 0 !important; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: #f8f9fa;
        }
        #map { height: 100%; width: 100%; background-color: #e9ecef; border: 1px solid #dee2e6; }
        .header { background-color: #ffffff; border-bottom: 1px solid #dee2e6; color: #212529; }
        .sidebar { background-color: #ffffff; border-right: 1px solid #dee2e6; width: 320px; }
        .info-box, .filter-box { background-color: #f8f9fa; border: 1px solid #dee2e6; }
        .info-title, .filter-title {
            font-weight: 600; color: #495057; margin-bottom: 0.5rem;
            text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px;
        }
        .info-data { font-size: 1.1rem; font-weight: 500; color: #212529; word-break: break-all; }
        .info-data-small { font-size: 0.9rem; color: #6c757d; }
        .form-input, .form-select { width: 100%; padding: 0.5rem 0.75rem; font-size: 0.9rem; color: #495057; background-color: #fff; border: 1px solid #ced4da; }
        .btn { width: 100%; padding: 0.6rem; font-size: 0.9rem; font-weight: 600; color: #fff; cursor: pointer; border: 1px solid; transition: background-color .15s ease-in-out; text-align: center; }
        .btn-primary { background-color: #0056b3; border-color: #0056b3; }
        .btn-primary:hover { background-color: #004494; }
        .btn-secondary { background-color: #6c757d; border-color: #6c757d; }
        .btn-secondary:hover { background-color: #5a6268; }
        #loading-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: 600; color: #343a40; }
        .drifter-icon-wrapper { animation: blink 1.5s infinite ease-in-out; position: relative; }
        .drifter-buoy-svg { width: 32px; height: 32px; }
        .drifter-name-label { position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); white-space: nowrap; background-color: rgba(255, 255, 255, 0.7); padding: 2px 5px; font-size: 0.7rem; font-weight: 600; color: #333; border: 1px solid #ccc; pointer-events: none; z-index: 1000; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        .drifter-tooltip { font-family: inherit; font-size: 0.9rem; padding: 6px 8px; }
    </style>
</head>

<body class="h-full flex flex-col">

    <header class="header w-full p-4 flex justify-between items-center shadow-sm z-50 relative">
        <div class="flex items-center space-x-2">
            <button id="menu-toggle-btn" class="md:hidden p-1 text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>
            </button>
            <h1 class="text-xl font-bold">UNIB Drifter Dashboard</h1>
        </div>
        <div class="flex items-center space-x-3">
            <span id="connection-status" class="text-sm font-medium px-2 py-1 bg-gray-200 text-gray-600">Connecting...</span>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        <aside id="sidebar" class="sidebar h-full overflow-y-auto p-5 space-y-4 flex-shrink-0 fixed md:relative z-40 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
            <div class="flex justify-between items-center pb-2 border-b border-gray-300 md:hidden">
                <h2 class="text-lg font-bold">Menu</h2>
                <button id="menu-close-btn" class="p-1 text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>

            <div class="filter-box p-3">
                <h2 class="filter-title border-b border-gray-300 pb-2 mb-3">Filters</h2>
                <div class="space-y-3">
                    <div>
                        <label for="drifter-select" class="block text-sm font-medium text-gray-700 mb-1">Drifter Name</label>
                        <select id="drifter-select" class="form-select">
                            <option value="all">All Drifters</option>
                        </select>
                    </div>
                    <div>
                        <label for="start-time" class="block text-sm font-medium text-gray-700 mb-1">Start Time</label>
                        <input type="datetime-local" id="start-time" class="form-input">
                    </div>
                    <div>
                        <label for="end-time" class="block text-sm font-medium text-gray-700 mb-1">End Time</label>
                        <input type="datetime-local" id="end-time" class="form-input">
                    </div>
                    <button id="filter-button" class="btn btn-primary">Apply Filters</button>
                </div>
            </div>

            <div class="filter-box p-3">
                <h2 class="filter-title border-b border-gray-300 pb-2 mb-3">Data Actions</h2>
                <div class="space-y-2">
                    <button id="export-csv-button" class="btn btn-secondary">Export Filtered as CSV</button>
                    <button id="import-csv-btn-trigger" class="btn btn-secondary">Import Local File (CSV/GPX)</button>
                    <input type="file" id="csv-file-input" accept=".csv,.gpx" class="hidden">
                </div>
            </div>

            <div class="info-box p-3">
                <h2 class="info-title border-b border-gray-300 pb-2 mb-3">Latest Data</h2>
                <div id="latest-data-content" class="space-y-3">
                    <p id="latest-data-placeholder" class="text-sm text-gray-500">Select a drifter or import a file to view metrics.</p>
                    <div id="latest-data-info" class="hidden space-y-3">
                        <div>
                            <div class="info-title">Drifter Name</div>
                            <div id="latest-name" class="info-data">---</div>
                            <div id="latest-time-ago" class="info-data-small -mt-1 text-gray-500"></div>
                        </div>
                        <div>
                            <div class="info-title">Last Update</div>
                            <div id="latest-timestamp" class="info-data">---</div>
                        </div>
                        <div>
                            <div class="info-title">Coordinates</div>
                            <div id="latest-lat" class="info-data">---</div>
                            <div id="latest-lon" class="info-data">---</div>
                        </div>
                        <div>
                            <div class="info-title">Device Info</div>
                            <div id="latest-id" class="info-data-small">ID: ---</div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <main class="flex-1 h-full relative z-0">
            <div id="menu-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
            <div id="map"></div>
            <div id="loading-overlay"><span>Processing Ocean Data...</span></div>
        </main>
    </div>

    <!-- Metrics Chart Modal -->
    <div id="sst-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[10001] hidden items-center justify-center p-4">
        <div id="sst-modal-content" class="bg-white p-5 max-w-4xl w-full shadow-2xl">
            <div class="flex justify-between items-center border-b border-gray-300 pb-2 mb-3">
                <h2 id="sst-modal-title" class="text-lg font-bold">Metrics Time-series</h2>
                <div class="flex items-center space-x-3">
                    <select id="metric-selector" class="form-select py-1 px-2 text-sm border-gray-300 w-40"></select>
                    <button id="sst-modal-close-btn" class="p-1 text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
            </div>
            <div class="relative h-64 md:h-96"><canvas id="sst-chart"></canvas></div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[10002] hidden items-center justify-center p-4">
        <div class="bg-white p-6 max-w-md w-full shadow-lg border border-gray-300 text-center">
            <h2 id="notification-title" class="text-xl font-bold mb-4">Notification</h2>
            <p id="notification-message" class="text-gray-600 mb-6"></p>
            <div class="flex flex-col space-y-2">
                <button id="modal-upload-btn" class="btn btn-primary hidden">Upload Local File</button>
                <button id="notification-close-btn" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- 1. CONFIG & GLOBALS ---
        const SUPABASE_URL = 'https://oeapjvhpekxqweybgbkn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9lYXBqdmhwZWt4cXdleWJnYmtuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NDk2NzUsImV4cCI6MjA3NzEyNTY3NX0.iC3GVorZid05A1PiJ_tmq3WmOLmPE_IS4FmHLS3TJPk';

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const statusEl = document.getElementById('connection-status');
        const loadingEl = document.getElementById('loading-overlay');
        const sidebar = document.getElementById('sidebar');
        const menuOverlay = document.getElementById('menu-overlay');
        const drifterSelect = document.getElementById('drifter-select');
        const startTimeInput = document.getElementById('start-time');
        const endTimeInput = document.getElementById('end-time');
        const latestNameEl = document.getElementById('latest-name');
        const latestIdEl = document.getElementById('latest-id');
        const timestampEl = document.getElementById('latest-timestamp');
        const timeAgoEl = document.getElementById('latest-time-ago');
        const latEl = document.getElementById('latest-lat');
        const lonEl = document.getElementById('latest-lon');
        const sstModal = document.getElementById('sst-modal');
        const sstModalTitle = document.getElementById('sst-modal-title');
        const metricSelector = document.getElementById('metric-selector');
        const sstChartCanvas = document.getElementById('sst-chart').getContext('2d');
        const notificationModal = document.getElementById('notification-modal');
        const csvFileInput = document.getElementById('csv-file-input');

        const map = L.map('map').setView([0, 0], 3);
        const dataLayers = L.layerGroup().addTo(map);
        let drifterInfoCache = {};
        const drifterColors = ['#0056b3', '#d9534f', '#5cb85c', '#f0ad4e', '#5bc0de', '#337ab7', '#c9302c', '#449d44', '#ec971f', '#46b8da'];
        let sstChartInstance = null;
        let currentPositionsData = null;

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(map);

        // --- 2. CORE LOGIC FUNCTIONS ---

        function showNotificationModal(title, message, showUpload = false) {
            document.getElementById('notification-title').textContent = title;
            document.getElementById('notification-message').textContent = message;
            document.getElementById('modal-upload-btn').classList.toggle('hidden', !showUpload);
            notificationModal.classList.remove('hidden');
            notificationModal.classList.add('flex');
        }

        function hideNotificationModal() { notificationModal.classList.add('hidden'); notificationModal.classList.remove('flex'); }

        function hideSstChartModal() {
            sstModal.classList.add('hidden'); sstModal.classList.remove('flex');
            if (sstChartInstance) { sstChartInstance.destroy(); sstChartInstance = null; }
        }

        function clearSidebar() {
            const placeholder = document.getElementById('latest-data-placeholder');
            if (placeholder) placeholder.style.display = 'block'; 
            document.getElementById('latest-data-info').classList.add('hidden');
        }

        function updateSidebar(latestData) {
            if (!latestData) { clearSidebar(); return; }
            const placeholder = document.getElementById('latest-data-placeholder');
            if (placeholder) placeholder.style.display = 'none'; 
            document.getElementById('latest-data-info').classList.remove('hidden');
            latestNameEl.textContent = drifterInfoCache[latestData.drifter_id] || latestData.drifter_id.replace(/local_|_\d+/g, ' ');
            timeAgoEl.textContent = formatTimeAgo(latestData.timestamp);
            latestIdEl.textContent = `ID: ${latestData.drifter_id}`;
            timestampEl.textContent = new Date(latestData.timestamp).toLocaleString();
            latEl.textContent = latestData.latitude.toFixed(6); 
            lonEl.textContent = latestData.longitude.toFixed(6);
        }

        function formatTimeAgo(timestamp) {
            const past = new Date(timestamp); 
            if (isNaN(past.getTime())) return "unknown";
            const seconds = Math.floor((new Date() - past) / 1000);
            if (seconds < 60) return "just now";
            const intervals = { year: 31536000, month: 2592000, day: 86400, hour: 3600, minute: 60 };
            for (let name in intervals) {
                let interval = Math.floor(seconds / intervals[name]);
                if (interval >= 1) return interval + " " + name + (interval > 1 ? "s" : "") + " ago";
            }
            return "just now";
        }

        async function populateDrifterDropdown() {
            try {
                const { data, error } = await db.from('drifters').select('id, name');
                if (error) throw error;
                data.forEach(drifter => {
                    drifterInfoCache[drifter.id] = drifter.name;
                    const option = document.createElement('option');
                    option.value = drifter.id;
                    option.textContent = drifter.name; 
                    drifterSelect.appendChild(option);
                });
            } catch (err) {
                showNotificationModal("Connection Issue", "Database unreachable. Please upload a local file.");
            }
        }
        
        async function fetchAndPlotData() {
            statusEl.textContent = 'Fetching...';
            loadingEl.style.display = 'flex';
            dataLayers.clearLayers(); clearSidebar();
            try {
                const selectedDrifterId = drifterSelect.value;
                const startTime = startTimeInput.value;
                const endTime = endTimeInput.value;
                let query = db.from('drifter_positions').select('*').order('timestamp', { ascending: false }).limit(2000); 
                if (selectedDrifterId !== 'all') query = query.eq('drifter_id', selectedDrifterId);
                if (startTime) query = query.gte('timestamp', new Date(startTime).toISOString());
                if (endTime) query = query.lte('timestamp', new Date(endTime).toISOString());

                const { data, error } = await query;
                if (error) throw error;
                if (data && data.length > 0) {
                    plotData(data);
                    if (selectedDrifterId !== 'all') updateSidebar(data[0]); 
                    statusEl.textContent = 'Live';
                    statusEl.className = 'text-sm font-medium px-2 py-1 bg-green-200 text-green-800';
                } else {
                    statusEl.textContent = 'No Data';
                    showNotificationModal("No Current Data", "No data matches your filters in the database.");
                }
            } catch (err) {
                statusEl.textContent = 'Offline';
                showNotificationModal("Database Offline", "Unable to connect to the server.");
            } finally { loadingEl.style.display = 'none'; }
        }

        function plotData(data) {
            const dataByDrifter = data.reduce((acc, pos) => {
                if (!acc[pos.drifter_id]) acc[pos.drifter_id] = [];
                acc[pos.drifter_id].push(pos);
                return acc;
            }, {});

            let allLatLngs = []; let drifterIndex = 0;
            for (const drifterId in dataByDrifter) {
                const positions = dataByDrifter[drifterId];
                const latLngs = positions.map(pos => [pos.latitude, pos.longitude]).reverse();
                allLatLngs.push(...latLngs);
                const color = drifterColors[drifterIndex % drifterColors.length];
                const drifterName = drifterInfoCache[drifterId] || drifterId.replace(/local_|_\d+/g, ' ').replace(/_/g, ' ');
                drifterIndex++;

                L.polyline(latLngs, { color: color, weight: 3, dashArray: '5, 10' }).addTo(dataLayers);
                positions.forEach(pos => {
                    const ts = new Date(pos.timestamp).toLocaleString();
                    const tooltip = `<div><b>${drifterName}</b><br>${ts}<br>Lat: ${pos.latitude.toFixed(4)} Lon: ${pos.longitude.toFixed(4)}</div>`;
                    L.circleMarker([pos.latitude, pos.longitude], { radius: 6, color: 'transparent', opacity: 0, fillOpacity: 0 })
                        .bindTooltip(tooltip, { sticky: true, className: 'drifter-tooltip' })
                        .addTo(dataLayers);
                });

                const latest = positions[0]; 
                const buoyHTML = `<div style="text-align: center;"><svg viewBox="0 0 32 32" class="drifter-buoy-svg"><path fill="${color}" stroke="#333" d="M16 18 C10 18, 6 21, 6 26 C6 31, 10 34, 16 34 C22 34, 26 31, 26 26 C26 21, 22 18, 16 18 Z" /><line stroke="#333" stroke-width="2" x1="16" y1="18" x2="16" y2="4" /><circle fill="${color}" stroke="#333" cx="16" cy="3" r="3" /></svg><div class="drifter-name-label">${drifterName}</div></div>`;
                const buoyIcon = L.divIcon({ className: 'drifter-icon-wrapper', html: buoyHTML, iconSize: [32, 32], iconAnchor: [16, 32] });

                L.marker([latest.latitude, latest.longitude], { icon: buoyIcon })
                    .bindPopup(`<div><b>${drifterName}</b><br>Latest: ${new Date(latest.timestamp).toLocaleString()}</div>`)
                    .on('mouseover', function(){ this.openPopup(); })
                    .on('mouseout', function(){ this.closePopup(); })
                    .on('click', () => showMetricsChartModal(positions, drifterName))
                    .addTo(dataLayers);
            }
            if (allLatLngs.length > 0) map.fitBounds(L.latLngBounds(allLatLngs).pad(0.1));
        }

        function showMetricsChartModal(positionsData, drifterName) {
            currentPositionsData = positionsData;
            const metrics = new Set();
            positionsData.forEach(pos => {
                if (pos.battery_level !== null) metrics.add('battery_level');
                if (pos.other_data) Object.keys(pos.other_data).forEach(k => { if (typeof pos.other_data[k] === 'number') metrics.add(k); });
            });
            const metricsList = Array.from(metrics).sort();
            metricSelector.innerHTML = '';
            metricsList.forEach(m => {
                const opt = document.createElement('option'); opt.value = m; opt.textContent = m.toUpperCase().replace(/_/g, ' ');
                metricSelector.appendChild(opt);
            });
            metricSelector.value = metricsList.includes('sst') ? 'sst' : (metricsList.includes('sst_c') ? 'sst_c' : (metricsList[0] || ''));
            refreshChart(drifterName);
            sstModal.classList.remove('hidden'); sstModal.classList.add('flex');
        }

        function refreshChart(drifterName) {
            if (!currentPositionsData) return;
            const m = metricSelector.value;
            if (!m) return;
            const chartData = currentPositionsData.slice().reverse(); 
            const labels = chartData.map(pos => new Date(pos.timestamp).toLocaleString());
            const values = chartData.map(pos => m === 'battery_level' ? pos.battery_level : pos.other_data?.[m] ?? null);
            if (sstChartInstance) sstChartInstance.destroy();
            sstModalTitle.textContent = `${m.toUpperCase()} Time-series: ${drifterName}`;
            sstChartInstance = new Chart(sstChartCanvas, {
                type: 'line',
                data: { labels, datasets: [{ label: m.toUpperCase(), data: values, borderColor: '#0056b3', backgroundColor: 'rgba(0, 86, 179, 0.1)', borderWidth: 2, fill: true, tension: 0.1, spanGaps: true }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function parseCSV(text, fileName) {
            try {
                const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
                if (lines.length < 2) return [];
                
                let startRow = 1;
                if (lines[1] && (lines[1].toLowerCase().includes('utc') || lines[1].toLowerCase().includes('degree') || lines[1].toLowerCase().includes('north'))) {
                    startRow = 2;
                }

                const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/"/g, ''));
                const idx = {
                    lat: headers.findIndex(h => ['latitude', 'lat', 'degrees_north', 'y'].includes(h)),
                    lon: headers.findIndex(h => ['longitude', 'lon', 'lng', 'degrees_east', 'x'].includes(h)),
                    time: headers.findIndex(h => ['time', 'timestamp', 'date_time', 'utc'].includes(h)),
                    date: headers.findIndex(h => h === 'date'),
                    id: headers.findIndex(h => ['id', 'drifter_id', 'name', 'platform'].includes(h))
                };

                if (idx.lat === -1 || idx.lon === -1) return [];

                const data = [];
                for (let i = startRow; i < lines.length; i++) {
                    const vals = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                    if (vals.length < 3) continue;
                    const lat = parseFloat(vals[idx.lat]), lon = parseFloat(vals[idx.lon]);
                    if (isNaN(lat) || isNaN(lon)) continue;

                    let dateStr = "";
                    if (idx.date !== -1 && idx.time !== -1 && vals[idx.date]) {
                        let dPart = vals[idx.date];
                        if (dPart.includes('/')) {
                            const p = dPart.split('/');
                            if (p.length === 3 && p[2].length === 4) dPart = `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;
                        }
                        dateStr = `${dPart}T${vals[idx.time]}`;
                    } else {
                        dateStr = vals[idx.time] || new Date().toISOString();
                    }

                    const ts = new Date(dateStr);
                    if (isNaN(ts.getTime())) continue;

                    const other = {}; let batt = null;
                    headers.forEach((h, j) => {
                        let val = parseFloat(vals[j]);
                        if (isNaN(val)) val = null; 
                        if ([idx.lat, idx.lon, idx.time, idx.id, idx.date].includes(j)) return;
                        if (h.includes('battery')) batt = val;
                        else if (val !== null) other[h] = val;
                    });
                    data.push({ drifter_id: idx.id !== -1 ? vals[idx.id] : `local_${fileName}`, timestamp: ts.toISOString(), latitude: lat, longitude: lon, battery_level: batt, other_data: other });
                }
                return data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            } catch (e) { return []; }
        }

        function parseGPX(xmlText, fileName) {
            try {
                const xml = new DOMParser().parseFromString(xmlText, "text/xml");
                const trkpts = Array.from(xml.getElementsByTagName("trkpt"));
                return trkpts.map(pt => ({
                    drifter_id: `local_${fileName}`,
                    timestamp: new Date(pt.getElementsByTagName("time")[0]?.textContent || Date.now()).toISOString(),
                    latitude: parseFloat(pt.getAttribute("lat")), longitude: parseFloat(pt.getAttribute("lon")),
                    battery_level: null,
                    other_data: { ele: parseFloat(pt.getElementsByTagName("ele")[0]?.textContent || 0) }
                })).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            } catch (e) { return []; }
        }

        function processRawData(content, identifier) {
            let parsed = identifier.endsWith('.gpx') ? parseGPX(content, identifier) : parseCSV(content, identifier);
            if (!parsed || parsed.length === 0) { 
                showNotificationModal("Parsing Error", "No valid tracks found. Check your file format.");
                loadingEl.style.display = 'none'; return; 
            }
            if (parsed.length > 5000) parsed = parsed.slice(0, 5000); 
            dataLayers.clearLayers(); clearSidebar();
            plotData(parsed); 
            updateSidebar(parsed[0]);
            statusEl.textContent = 'Import Mode'; statusEl.className = 'text-sm font-medium px-2 py-1 bg-blue-200 text-blue-800';
            loadingEl.style.display = 'none';
        }

        // --- 3. EVENT LISTENERS ---

        document.getElementById('menu-toggle-btn').addEventListener('click', () => { sidebar.classList.toggle('-translate-x-full'); menuOverlay.classList.toggle('hidden'); });
        document.getElementById('menu-close-btn').addEventListener('click', () => { sidebar.classList.add('-translate-x-full'); menuOverlay.classList.add('hidden'); });
        menuOverlay.addEventListener('click', () => { sidebar.classList.add('-translate-x-full'); menuOverlay.classList.add('hidden'); });
        document.getElementById('filter-button').addEventListener('click', fetchAndPlotData);
        
        document.getElementById('import-csv-btn-trigger').addEventListener('click', () => csvFileInput.click());
        csvFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0]; if (!file) return;
            loadingEl.style.display = 'flex';
            const reader = new FileReader();
            reader.onload = (re) => processRawData(re.target.result, file.name);
            reader.readAsText(file);
        });

        document.getElementById('export-csv-button').addEventListener('click', async () => {
            const drifterId = drifterSelect.value;
            if (drifterId === 'all') return;
            const { data, error } = await db.from('drifter_positions').select('*').eq('drifter_id', drifterId).limit(2000);
            if(!data || data.length === 0) return;
            const blob = new Blob([Object.keys(data[0]).join(',') + '\n' + data.map(r => Object.values(r).join(',')).join('\n')], { type: 'text/csv' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'drifter_export.csv'; a.click();
        });

        document.getElementById('sst-modal-close-btn').addEventListener('click', hideSstChartModal);
        document.getElementById('notification-close-btn').addEventListener('click', hideNotificationModal);
        document.getElementById('modal-upload-btn').addEventListener('click', () => { hideNotificationModal(); csvFileInput.click(); });
        metricSelector.addEventListener('change', () => refreshChart(latestNameEl.textContent));

        // Initial load
        map.whenReady(async () => {
            await populateDrifterDropdown();
            await fetchAndPlotData(); 
        });
    </script>
</body>
</html>
